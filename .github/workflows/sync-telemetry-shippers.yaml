name: Sync Telemetry Shippers

on:
  workflow_run:
    workflows: ["Coralogix-OpenTelemetry-Collector-Helm-Chart"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  notify:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Get version
        id: version
        run: |
          VERSION=$(yq '.version' charts/opentelemetry-collector/Chart.yaml)
          echo "value=$VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"

      - name: Get source PR
        id: pr
        run: |
          # Get the PR that was merged in the workflow run commit
          PR_URL=$(gh pr list --state merged --search "${{ github.event.workflow_run.head_sha }}" --json url --jq '.[0].url' 2>/dev/null || echo "")
          echo "url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Source PR: $PR_URL"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract changelog
        id: changelog
        run: |
          # Extract first version block from CHANGELOG.md (latest version)
          CHANGELOG=$(awk '
            /^[[:space:]]*### v/ {
              if (seen) exit
              seen=1
              next
            }
            seen {print}
          ' charts/opentelemetry-collector/CHANGELOG.md | sed '/^[[:space:]]*$/d')
          
          if [[ -n "$CHANGELOG" ]]; then
            # Base64 encode to preserve newlines and special chars
            CHANGELOG_B64=$(echo "$CHANGELOG" | base64 -w0)
            echo "changelog_b64=$CHANGELOG_B64" >> $GITHUB_OUTPUT
            echo "Changelog extracted (${#CHANGELOG} chars)"
          else
            echo "changelog_b64=" >> $GITHUB_OUTPUT
            echo "No changelog found"
          fi

      - name: Dispatch to telemetry-shippers
        run: |
          gh api repos/coralogix/telemetry-shippers/dispatches \
            -f event_type=otel-collector-release \
            -f "client_payload[version]=${{ steps.version.outputs.value }}" \
            -f "client_payload[pr_url]=${{ steps.pr.outputs.url }}" \
            -f "client_payload[changelog_b64]=${{ steps.changelog.outputs.changelog_b64 }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
